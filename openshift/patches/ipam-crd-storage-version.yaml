# Pin IPAM CRDs to use v1beta1 as the storage version.
#
# Upstream CAPI did set v1beta2 as storage version immediately after it was added,
# but according to our downstream policy, a new APIVersion cannot be set as storage version
# in the same release it gets added. As this would hinder the ability to roll it back in case of an issue.
# As such we need to pin the storage version to v1beta1 for at least the first release we GA cluster-api.
# After that, we can bump the storage version to v1beta2, and run the storage version migration.
#
# Targets (specified in kustomization.yaml):
#   - ipaddresses.ipam.cluster.x-k8s.io
#   - ipaddressclaims.ipam.cluster.x-k8s.io
#
# For both CAPI IPAM CRDs, the version order in the CRD spec is: v1alpha1 (0), v1beta1 (1), v1beta2 (2)
# so use a replace that targets the apiVersion path by position in the CRD spec.

# Set v1beta1 storage=true
- op: replace
  path: /spec/versions/1/storage
  value: true

# Set v1beta2 storage=false
- op: replace
  path: /spec/versions/2/storage
  value: false
